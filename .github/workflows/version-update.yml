name : Update Version

on:
    workflow_dispatch:

jobs:
    update-version:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            issues: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            
            - name: Validate version.json   
              run: |
                if [ ! -f "version.json" ]; then
                  echo "❌ version.json not found."
                  exit 1
                fi

                version=$(jq -r '.version' version.json)

                if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  echo "❌ Invalid version format: $version"
                  exit 1
                fi

                echo "✅ version.json is valid: $version"

            - name: Set up Git
              run: |
                git config --global user.name "github-actions[bot]"
                git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Increment version.json
              id: increment_version
              run: |
                current_version=$(jq -r '.version' version.json)
                echo "Current version: $current_version"

                IFS='.' read -r major minor patch <<< "$current_version"
                patch=$((patch + 1))

                new_version="$major.$minor.$patch"
                echo "New version: $new_version"

                echo "{\"version\": \"$new_version\"}" > version.json

                echo "new_version=$new_version" >> $GITHUB_OUTPUT
            
            - name: Update version in .csproj
              run: |
                csproj_file=$(find . -name "*.csproj")
                echo "Updating $csproj_file"

   
                version="${{ steps.increment_version.outputs.new_version }}"
                major=$(echo "$version" | cut -d. -f1)
                
                sed -i "s|<ApplicationDisplayVersion>.*</ApplicationDisplayVersion>|<ApplicationDisplayVersion>${version}</ApplicationDisplayVersion>|" "$csproj_file"

                sed -i "s|<ApplicationVersion>.*</ApplicationVersion>|<ApplicationVersion>${major}</ApplicationVersion>|" "$csproj_file"

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v6
              with:
                token: ${{secrets.GITHUB_TOKEN}}
                branch: "update-version-${{steps.increment_version.outputs.new_version}}"
                title:"chore: bump version to ${{steps.increment_version.outputs.new_version}}"
                body: "This PR updates the version to ${{steps.increment_version.outputs.new_version}}"
                base: master
                labels: auto-update, versioning
                reviewers: RenatoSSouza
                assignees: RenatoSSouza
